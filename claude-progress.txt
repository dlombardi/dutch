# Evn Development Progress

## Project Overview
- App Name: Evn
- Tagline: "Splitwise without the paywall"
- Tech: Expo (React Native) + NestJS + PostgreSQL
- Target: Sub-10-second expense entry for travel groups

## Session Log
(Future sessions will append their progress here)

### Session 1 - 2025-11-28 - Initial Scaffolding
- Initialized Turborepo monorepo structure
- Created feature_list.json with 135 features
- Set up Expo mobile app skeleton
- Set up NestJS API skeleton
- Set up React PWA web app skeleton
- Created shared packages structure
- Defined database schema (TypeORM entities)
- Created init.sh bootstrap script

## Current State
- Project initialized: 2025-11-28
- Features total: 135
- Features passing: 5
- Current focus: Implementing Priority 1 groups features

## Feature Breakdown by Category
- auth: 12 features
- groups: 15 features
- expenses: 20 features
- splits: 8 features
- currency: 8 features
- settlements: 10 features
- sync: 6 features
- notifications: 6 features
- web-pwa: 6 features
- offline: 7 features
- settings: 11 features
- edge-cases: 26 features

## Feature Breakdown by Priority
- Priority 1 (Core MVP): 28 features
- Priority 2 (MVP Important): 39 features
- Priority 3 (Fast-follow): 28 features
- Priority 4 (Nice to have): 27 features
- Priority 5 (Polish): 3 features

## Architecture Decisions
(Document key decisions here as they're made)

### AD-001: Monorepo Structure
- Using Turborepo for build orchestration
- apps/mobile (Expo), apps/web (Vite React), apps/api (NestJS)
- packages/shared for business logic reuse

### AD-002: State Management
- Zustand for client state (lightweight, simple API)
- WatermelonDB for local-first offline storage
- WebSocket for real-time sync

### AD-003: Styling
- NativeWind (Tailwind for React Native) on mobile
- Tailwind CSS on web
- Shared design tokens via packages/config

### AD-004: Authentication
- Magic link as primary auth for account creators
- Name-only guest auth for frictionless invites
- JWT tokens with refresh mechanism

## Known Issues
(Track bugs and technical debt here)

- None yet (project just initialized)

## Next Steps for Future Sessions
1. Implement auth-magic-link-request (Priority 1)
2. Implement auth-magic-link-verify (Priority 1)
3. Implement auth-guest-name-entry (Priority 1)
4. Implement groups-create-basic (Priority 1)
5. Set up database and run initial migrations

---

## Session: 2025-11-28 (Session 2)
Working on: auth-magic-link-request
Description: User can request a magic link by entering their email address

### auth-magic-link-request - COMPLETE
- Implemented:
  - NestJS auth module with AuthService and AuthController
  - Magic link entity for storing tokens
  - POST /auth/magic-link/request endpoint
  - POST /auth/magic-link/verify endpoint
  - Mobile sign-in screen with email input
  - Magic link sent confirmation screen
  - Auth store with API integration
  - Root layout with auth flow protection
- Verified:
  - API endpoint returns success message
  - Email validation works (rejects invalid emails)
  - Magic link token is generated and logged
  - Token verification returns user and accessToken
- Commit: 9c98a71
- Notes: Using in-memory storage for now, will migrate to TypeORM later

### auth-magic-link-verify - INCOMPLETE
- Backend endpoint implemented: POST /auth/magic-link/verify works
- Mobile verifyMagicLink() store function exists
- MISSING: Deep linking URL scheme not configured in app.json
- MISSING: No code to handle incoming magic link URLs
- MISSING: No screen to process magic link tokens from URLs
- Status: Only API side complete, mobile deep linking flow not implemented

---

## Session: 2025-11-28 (Session 3)
Working on: auth-magic-link-verify
Description: User can authenticate by clicking the magic link in their email

### auth-magic-link-verify - COMPLETE
- Implemented:
  - Deep linking URL scheme configured in app.json (scheme: "evn")
  - Created auth/verify.tsx screen to handle magic link tokens
  - Updated root layout to allow auth/verify route without authentication
  - Deep link URL format: evn://auth/verify?token=xxx
- Tests added:
  - apps/api/src/auth/__tests__/auth.controller.spec.ts (8 tests)
    - Valid token verification returns user + accessToken
    - Invalid token rejection
    - Already-used token rejection
    - Same user returned for same email
    - Empty token rejection
- Verified:
  - API endpoint verifies tokens correctly
  - Mobile app has deep link configuration
  - Session persists via AsyncStorage (zustand persist middleware)
- Commit: 2ccc00f
- Notes: Full E2E testing requires running on device/simulator to test deep links

---

## Session: 2025-11-28 (Session 4)
Working on: auth-guest-name-entry
Description: Guest user can join a group by entering only their name

### auth-guest-name-entry - COMPLETE
- Implemented:
  - API: POST /auth/guest endpoint with name and deviceId params
  - GuestAuthDto with validation (name required, deviceId required, name trimming)
  - AuthService.createGuestUser() stores guest users by device ID
  - Mobile: guest-join.tsx screen with name input form
  - Mobile: Updated sign-in.tsx "Continue as guest" to navigate to guest-join
  - Mobile: authStore.loginAsGuest() calls API and stores session
  - Device ID generation and persistence via AsyncStorage
- Tests added:
  - apps/api/src/auth/__tests__/guest-auth.controller.spec.ts (8 tests)
    - Create guest user with name and device ID
    - Return existing guest for same device ID
    - Update name on re-registration
    - Empty name rejection
    - Missing name rejection
    - Empty device ID rejection
    - Missing device ID rejection
    - Whitespace trimming on name
- Verified:
  - All 17 API tests pass (9 magic link + 8 guest auth)
  - Mobile TypeScript compiles without errors
- Status: Feature complete

---

## Session: 2025-11-28 (Session 5)
Working on: auth-guest-device-persistence
Description: Guest user session persists on the same device

### auth-guest-device-persistence - COMPLETE
- Implemented:
  - API: Same device ID returns same user (already working from previous session)
  - Mobile: Added onRehydrateStorage callback to restore accessToken to API client
  - Session data (user, accessToken, isAuthenticated) persisted via zustand persist
  - Device ID persisted via AsyncStorage
- Tests added:
  - apps/api/src/auth/__tests__/guest-persistence.controller.spec.ts (4 tests)
    - Same user returned when re-authenticating with same device ID
    - User data preserved across multiple sessions
    - New access token issued each session while preserving identity
    - User type remains 'guest' across sessions
- Verified:
  - All 21 API tests pass (17 existing + 4 new persistence tests)
  - Mobile TypeScript compiles without errors
- Status: Feature complete

---

## Session: 2025-11-28 (Session 5 continued)
Working on: groups-create-basic
Description: User can create a new group with name and emoji

### groups-create-basic - COMPLETE
- Implemented:
  - API: GroupsModule with controller, service, and DTOs
  - API: POST /groups endpoint creates group with name, emoji, defaultCurrency
  - API: GET /groups/:id endpoint retrieves group by ID
  - API: Unique 6-character invite codes auto-generated
  - API: Name trimming and validation via class-validator
  - Mobile: groupsStore with createGroup, fetchGroup actions
  - Mobile: api.ts createGroup and getGroup methods
  - Mobile: create-group.tsx screen with emoji picker and name input
  - Mobile: Updated (tabs)/index.tsx to use real groups store
- Tests added:
  - apps/api/src/groups/__tests__/groups.controller.spec.ts (11 tests)
    - Create group with name and emoji
    - Default emoji if not provided
    - Custom defaultCurrency
    - Default currency is USD
    - Reject empty name
    - Reject whitespace-only name
    - Generate unique invite codes
    - Trim whitespace from name
    - Get group by ID
    - Return 404 for non-existent group
    - Multiple groups have unique invite codes
- Verified:
  - All 32 API tests pass (21 auth + 11 groups)
  - Mobile TypeScript compiles without errors
- Status: Feature complete
