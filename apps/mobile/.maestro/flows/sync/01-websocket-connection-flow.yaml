# Test: WebSocket Connection Flow
# Description: Verify WebSocket connection establishes on app launch
# Tags: sync, websocket
# Note: This test verifies the app can establish and maintain real-time connection
# Visual indicators and reconnection behavior are tested

appId: com.evn.app

---
# Launch the app and login as guest
- runFlow: ../../subflows/launch-app.yaml
- runFlow: ../../subflows/login-as-guest.yaml

# Wait for main screen
- extendedWaitUntil:
    visible: "Groups"
    timeout: 10000

# Create a group to join a sync room
- runFlow:
    file: ../../subflows/create-group.yaml
    env:
      groupName: "Sync Test Group"
      emoji: "ðŸ”„"

# Wait for group detail - WebSocket should be connected now
- extendedWaitUntil:
    visible: "Sync Test Group"
    timeout: 10000

# The app should now be subscribed to this group's real-time updates
# Note: Connection status may not be visible in UI but sync is happening

# Verify the group is fully loaded (indicates sync is working)
- assertVisible: "Your balance"
- assertVisible: "Expenses"
- assertVisible: "Balances"
- assertVisible: "Members"

# Add an expense to verify real-time update capability
- tapOn: "+ Add Expense"
- tapOn: "0.00"
- inputText: "25.00"
- tapOn: "What was this for?"
- inputText: "Sync test expense"
- tapOn: "Save"

# Expense should appear immediately via WebSocket
- extendedWaitUntil:
    visible: "Sync test expense"
    timeout: 5000

# Verify balance updated in real-time
- assertVisible: "Your balance"
